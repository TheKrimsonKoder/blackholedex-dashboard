name: Post Tweet (manual or scheduled)

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Preview only (DRY_RUN)"
        required: true
        default: "true"
        type: choice
        options: ["true", "false"]
  # Optional schedule for auto-post time:
  # schedule:
  #   - cron: "30 17 * * *"   # 17:30 UTC daily

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout repo
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install "tweepy>=4.14,<5" pandas

      - name: üß™ Preview summary (for manual runs)
        run: |
          echo "---- data/daily_summary.txt ----"
          (test -f data/daily_summary.txt && cat data/daily_summary.txt) || echo "(missing)"

      # Create a date string we can reuse in artifact names/logs
      - name: üóìÔ∏è Capture UTC date
        id: meta
        run: echo "date=$(date -u +'%Y-%m-%d')" >> "$GITHUB_OUTPUT"

      - name: üê¶ Post to X
        env:
          X_API_KEY:      ${{ secrets.X_API_KEY }}
          X_API_SECRET:   ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
          DRY_RUN:        ${{ github.event.inputs.dry_run }}
        run: python scripts/post_tweet.py

      # Upload the exact inputs used for this post (runs even if tweet step fails)
      - name: üìé Upload artifacts (summary + csv)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tweet-inputs-${{ steps.meta.outputs.date }}-${{ github.run_number }}
          path: |
            data/daily_summary.txt
            data/black_metrics.csv
          if-no-files-found: warn
          retention-days: 7
